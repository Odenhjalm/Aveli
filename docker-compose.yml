version: "3.9"

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      APP_ENV: ${APP_ENV:-development}
      DATABASE_URL: ${DATABASE_URL:?set DATABASE_URL}
      SUPABASE_URL: ${SUPABASE_URL:?set SUPABASE_URL}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY:?set SUPABASE_SERVICE_ROLE_KEY}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY:?set SUPABASE_ANON_KEY}
      LIVEKIT_API_KEY: ${LIVEKIT_API_KEY:-}
      LIVEKIT_API_SECRET: ${LIVEKIT_API_SECRET:-}
      LIVEKIT_WS_URL: ${LIVEKIT_WS_URL:-}
      LIVEKIT_API_URL: ${LIVEKIT_API_URL:-}
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:?set STRIPE_SECRET_KEY}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}
      STRIPE_BILLING_WEBHOOK_SECRET: ${STRIPE_BILLING_WEBHOOK_SECRET:-}
      STRIPE_CHECKOUT_UI_MODE: ${STRIPE_CHECKOUT_UI_MODE:-custom}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
      JWT_SECRET: ${JWT_SECRET:?set JWT_SECRET}
      MEDIA_SIGNING_SECRET: ${MEDIA_SIGNING_SECRET:?set MEDIA_SIGNING_SECRET}
      MEDIA_SIGNING_TTL_SECONDS: ${MEDIA_SIGNING_TTL_SECONDS:-600}
      LESSON_MEDIA_MAX_BYTES: ${LESSON_MEDIA_MAX_BYTES:-2147483648}
    volumes:
      - ./backend/assets:/app/assets:ro
      - ./backend/media:/app/media
    ports:
      - "8000:8000"

  frontend:
    build:
      context: ./web
      dockerfile: Dockerfile
    environment:
      NEXT_PUBLIC_SUPABASE_URL: ${SUPABASE_URL}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      NEXT_PUBLIC_API_BASE_URL: ${FRONTEND_URL:-http://localhost:8000}
    ports:
      - "3000:3000"
    depends_on:
      - backend
