name: codex-agent
on:
  issue_comment:
    types: [created]
  issues:
    types: [labeled, opened, edited]

permissions:
  contents: write
  pull-requests: write

jobs:
  plan-and-pr:
    if: contains(toJson(github.event), '/agent ')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - id: parse
        run: |
          python - << 'PY'
          import json
          import os
          from pathlib import Path

          event_path = os.environ.get("GITHUB_EVENT_PATH")
          payload = json.loads(Path(event_path).read_text(encoding="utf-8"))

          body = ""
          comment = payload.get("comment")
          issue = payload.get("issue")
          if isinstance(comment, dict):
            body = comment.get("body") or ""
          elif isinstance(issue, dict):
            body = issue.get("body") or ""

          task = body.split("/agent ", 1)[1] if "/agent " in body else ""
          task = task.replace("\r\n", "\n").replace("\n", " ").strip()
          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as handle:
            handle.write(f"TASK={task}\n")
          PY

      - id: readprompt
        run: |
          echo "prompt<<'EOF'" >> $GITHUB_OUTPUT
          cat AGENT_PROMPT.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate patch with OpenAI
        id: gen
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python - << 'PY'
import os, json, urllib.request, subprocess
task = """${{ steps.parse.outputs.TASK }}"""
prompt = """Du är en senior Flutter/Fullstack-ingenjör.
Följ masterprompten:
---
${{ steps.readprompt.outputs.prompt }}
---
Uppgift: %s

Returnera ENDAST en giltig unified diff som kan appliceras med `git apply --whitespace=fix`.
""" % task
data = {
  "model":"gpt-4.1",
  "messages":[{"role":"user","content":prompt}],
  "temperature":0.2
}
req = urllib.request.Request(
  "https://api.openai.com/v1/chat/completions",
  data=json.dumps(data).encode(),
  headers={"Authorization": f"Bearer {os.environ['OPENAI_API_KEY']}",
           "Content-Type":"application/json"}
)
res = urllib.request.urlopen(req).read()
msg = json.loads(res)["choices"][0]["message"]["content"]
open("patch.diff","w").write(msg)
PY

      - name: Create PR from patch
        run: |
          set -e
          git config user.name "codex-agent"
          git config user.email "actions@users.noreply.github.com"
          git checkout -b agent/${{ github.run_id }}
          git apply --whitespace=fix patch.diff
          git add -A
          git commit -m "agent: ${{ steps.parse.outputs.TASK }}"
          git push -u origin HEAD
          gh pr create --title "agent: ${{ steps.parse.outputs.TASK }}" \
            --body "Automatisk PR från codex-agent.\n\nUppgift:\n${{ steps.parse.outputs.TASK }}" \
            --label automerge || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
