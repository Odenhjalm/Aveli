# Auth Ops Report (full-check)

## auth.users integrity
- Issues: none

```json
{
  "aud_nulls": 0,
  "role_nulls": 0,
  "email_nulls": 0,
  "duplicate_emails": [],
  "oauth_provider_missing": []
}
```

## Email Change NULL Check
- rows_found: 0
- rows_fixed: 0

- trigger_sql_block:
```sql
create or replace function auth.fix_null_email_change()
returns trigger
language plpgsql
as $$
begin
  if new.email_change is null then
    new.email_change := '';
  end if;
  return new;
end;
$$;

drop trigger if exists trg_fix_null_email_change on auth.users;
create trigger trg_fix_null_email_change
before insert on auth.users
for each row execute procedure auth.fix_null_email_change();
```

## Identity NULL String Check
- rows_found: 0
- rows_fixed: 0
- fields_checked:

- trigger_sql_block:
```sql
create or replace function auth.fix_null_identity_strings()
returns trigger as $$
begin
  if new.email_change is null then new.email_change := ''; end if;
  if new.email_change_sent_at is null then new.email_change_sent_at := ''; end if;
  if new.email_change_token_current is null then new.email_change_token_current := ''; end if;
  if new.email_change_token_new is null then new.email_change_token_new := ''; end if;
  if new.recovery_sent_at is null then new.recovery_sent_at := ''; end if;
  if new.recovery_token is null then new.recovery_token := ''; end if;
  return new;
end;
$$ language plpgsql;

drop trigger if exists trg_fix_null_identity_strings on auth.identities;

create trigger trg_fix_null_identity_strings
before insert on auth.identities
for each row execute function auth.fix_null_identity_strings();
```

## Instance Table Check
- rows_found: 1
- rows_fixed: 0
- default_instance_id: 55365731-0860-4de4-8d5b-374b05c56c6f
- sample_rows:
  - {'id': UUID('55365731-0860-4de4-8d5b-374b05c56c6f'), 'uuid': UUID('2f1d5a48-9062-4af5-a25a-51346bb1a9d9'), 'raw_base_config': '{}', 'created_at': datetime.datetime(2025, 12, 3, 2, 19, 46, 60891, tzinfo=datetime.timezone.utc), 'updated_at': datetime.datetime(2025, 12, 3, 2, 19, 46, 60891, tzinfo=datetime.timezone.utc)}

- trigger_sql_block:
```sql
create or replace function auth.fix_null_identity_instance_id()
returns trigger as $$
begin
  if new.instance_id is null then
    new.instance_id := (select id from auth.instances limit 1);
  end if;
  return new;
end;
$$ language plpgsql;

drop trigger if exists trg_fix_null_identity_instance_id on auth.identities;

create trigger trg_fix_null_identity_instance_id
before insert on auth.identities
for each row execute function auth.fix_null_identity_instance_id();

create or replace function auth.fix_null_instances_raw_base_config()
returns trigger as $$
begin
  if new.raw_base_config is null then
    new.raw_base_config := '{}';
  end if;
  return new;
end;
$$ language plpgsql;

drop trigger if exists trg_fix_null_instances_raw_base_config on auth.instances;

create trigger trg_fix_null_instances_raw_base_config
before insert on auth.instances
for each row execute function auth.fix_null_instances_raw_base_config();
```

## Identity Instance ID NULL Check
- rows_found: 0
- rows_fixed: 0
- default_instance_id: 55365731-0860-4de4-8d5b-374b05c56c6f

- trigger_sql_block:
```sql
create or replace function auth.fix_null_identity_instance_id()
returns trigger as $$
begin
  if new.instance_id is null then
    new.instance_id := (select id from auth.instances limit 1);
  end if;
  return new;
end;
$$ language plpgsql;

drop trigger if exists trg_fix_null_identity_instance_id on auth.identities;

create trigger trg_fix_null_identity_instance_id
before insert on auth.identities
for each row execute function auth.fix_null_identity_instance_id();
```

## Orphan identities (auth.identities without auth.users)
- Issues: none

```json
{
  "count": 0,
  "sample_rows": []
}
```

## Duplicate provider identities
- Issues: none

```json
{
  "duplicates": []
}
```

## Orphan sessions
- Issues: none

```json
{
  "count": 0,
  "sample_rows": []
}
```

## Orphan refresh_tokens
- Issues: none

```json
{
  "count": 0,
  "sample_rows": []
}
```

## Deleted/Banned users
- Issues: none

```json
{
  "count": 0,
  "sample_rows": []
}
```

## RLS status
- Issues: none

```json
{
  "rls": [
    [
      "app",
      "memberships",
      true
    ],
    [
      "app",
      "orders",
      true
    ],
    [
      "app",
      "profiles",
      true
    ],
    [
      "auth",
      "users",
      true
    ]
  ]
}
```

## Google OAuth provider config
- Issues: none

```json
{
  "google_enabled": true,
  "redirects": [
    "http://localhost:4003",
    "http://localhost:4003/#/login-callback",
    "http://localhost:4003/login-callback",
    "https://aveli.app",
    "https://aveli.app/login-callback",
    "https://aveli.app/stripe/cancel",
    "https://aveli.app/stripe/success",
    "https://evgwgepnscopsiznqkqc.supabase.co/auth/v1/callback"
  ],
  "missing_redirects": []
}
```

## Schema drift (auth/app)
- Issues: auth.users: expected columns not parsed from migrations; app.profiles: extra columns in DB -> avatar_media_id, stripe_customer_id; app.profiles: type mismatches -> updated_at expected timestamptz got timestamp with time zone; created_at expected timestamptz got timestamp with time zone; role_v2 expected app.user_role got USER-DEFINED; role expected app.profile_role got USER-DEFINED
- Actions: Proposed migration: /home/oden/Aveli/supabase/migrations/autofix_auth_20251203_182242.sql

```json
{
  "expected_columns": {
    "auth.users": {},
    "app.profiles": {
      "user_id": "uuid",
      "email": "text",
      "display_name": "text",
      "role": "app.profile_role",
      "role_v2": "app.user_role",
      "bio": "text",
      "photo_url": "text",
      "is_admin": "boolean",
      "created_at": "timestamptz",
      "updated_at": "timestamptz"
    }
  },
  "db_columns": {
    "auth.users": {
      "instance_id": "uuid",
      "id": "uuid",
      "aud": "character varying",
      "role": "character varying",
      "email": "character varying",
      "encrypted_password": "character varying",
      "email_confirmed_at": "timestamp with time zone",
      "invited_at": "timestamp with time zone",
      "confirmation_token": "character varying",
      "confirmation_sent_at": "timestamp with time zone",
      "recovery_token": "character varying",
      "recovery_sent_at": "timestamp with time zone",
      "email_change_token_new": "character varying",
      "email_change": "character varying",
      "email_change_sent_at": "timestamp with time zone",
      "last_sign_in_at": "timestamp with time zone",
      "raw_app_meta_data": "jsonb",
      "raw_user_meta_data": "jsonb",
      "is_super_admin": "boolean",
      "created_at": "timestamp with time zone",
      "updated_at": "timestamp with time zone",
      "phone": "text",
      "phone_confirmed_at": "timestamp with time zone",
      "phone_change": "text",
      "phone_change_token": "character varying",
      "phone_change_sent_at": "timestamp with time zone",
      "confirmed_at": "timestamp with time zone",
      "email_change_token_current": "character varying",
      "email_change_confirm_status": "smallint",
      "banned_until": "timestamp with time zone",
      "reauthentication_token": "character varying",
      "reauthentication_sent_at": "timestamp with time zone",
      "is_sso_user": "boolean",
      "deleted_at": "timestamp with time zone",
      "is_anonymous": "boolean"
    },
    "app.profiles": {
      "user_id": "uuid",
      "email": "text",
      "display_name": "text",
      "role": "USER-DEFINED",
      "role_v2": "USER-DEFINED",
      "bio": "text",
      "photo_url": "text",
      "is_admin": "boolean",
      "created_at": "timestamp with time zone",
      "updated_at": "timestamp with time zone",
      "avatar_media_id": "uuid",
      "stripe_customer_id": "text"
    }
  }
}
```

## Frontend/Backend auth wiring
- Issues: none
