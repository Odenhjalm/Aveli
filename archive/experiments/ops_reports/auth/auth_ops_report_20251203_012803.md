# Auth Ops Report (full-check)

## auth.users integrity
- Issues: none

```json
{
  "aud_nulls": 0,
  "role_nulls": 0,
  "email_nulls": 0,
  "duplicate_emails": [],
  "oauth_provider_missing": []
}
```

## Email Change NULL Check
- rows_found: 139
- rows_fixed: 0
- sample_rows:
  - {'id': UUID('e4ec9b47-5d9d-4490-aa83-2c364b7b0141'), 'email': 'smoke_6acaa6@wisdom.dev'}
  - {'id': UUID('1d6e8a92-2c3b-44fb-a5d6-82e977a21282'), 'email': 'billing_3521a936@example.com'}
  - {'id': UUID('586b40e2-842c-4ae8-8f63-dcd7e3daf916'), 'email': 'billing_28ced4e2@example.com'}
  - {'id': UUID('c635e150-818b-4d43-be20-182a1a402a16'), 'email': 'free_intro_e1913d67@example.com'}
  - {'id': UUID('010faf6d-9d7c-42f0-8fee-781de75d352e'), 'email': 'me_42f925b3@example.com'}

- trigger_sql_block:
```sql
create or replace function auth.fix_null_email_change()
returns trigger
language plpgsql
as $$
begin
  if new.email_change is null then
    new.email_change := '';
  end if;
  return new;
end;
$$;

drop trigger if exists trg_fix_null_email_change on auth.users;
create trigger trg_fix_null_email_change
before insert on auth.users
for each row execute procedure auth.fix_null_email_change();
```

## Identity NULL String Check
- rows_found: 0
- rows_fixed: 0
- fields_checked:

- trigger_sql_block:
```sql
create or replace function auth.fix_null_identity_strings()
returns trigger as $$
begin
  if new.email_change is null then new.email_change := ''; end if;
  if new.email_change_sent_at is null then new.email_change_sent_at := ''; end if;
  if new.email_change_token_current is null then new.email_change_token_current := ''; end if;
  if new.email_change_token_new is null then new.email_change_token_new := ''; end if;
  if new.recovery_sent_at is null then new.recovery_sent_at := ''; end if;
  if new.recovery_token is null then new.recovery_token := ''; end if;
  return new;
end;
$$ language plpgsql;

drop trigger if exists trg_fix_null_identity_strings on auth.identities;

create trigger trg_fix_null_identity_strings
before insert on auth.identities
for each row execute function auth.fix_null_identity_strings();
```

## RLS status
- Issues: none

```json
{
  "rls": [
    [
      "app",
      "memberships",
      true
    ],
    [
      "app",
      "orders",
      true
    ],
    [
      "app",
      "profiles",
      true
    ],
    [
      "auth",
      "users",
      true
    ]
  ]
}
```

## Google OAuth provider config
- Issues: none

```json
{
  "google_enabled": true,
  "redirects": [
    "http://localhost:4003",
    "http://localhost:4003/#/login-callback",
    "http://localhost:4003/login-callback",
    "https://aveli.app",
    "https://aveli.app/login-callback",
    "https://aveli.app/stripe/cancel",
    "https://aveli.app/stripe/success",
    "https://evgwgepnscopsiznqkqc.supabase.co/auth/v1/callback"
  ],
  "missing_redirects": []
}
```

## Schema drift (auth/app)
- Issues: auth.users: expected columns not parsed from migrations; app.profiles: extra columns in DB -> avatar_media_id, stripe_customer_id; app.profiles: type mismatches -> role_v2 expected app.user_role got USER-DEFINED; created_at expected timestamptz got timestamp with time zone; updated_at expected timestamptz got timestamp with time zone; role expected app.profile_role got USER-DEFINED
- Actions: Proposed migration: /home/oden/Aveli/supabase/migrations/autofix_auth_20251203_012802.sql

```json
{
  "expected_columns": {
    "auth.users": {},
    "app.profiles": {
      "user_id": "uuid",
      "email": "text",
      "display_name": "text",
      "role": "app.profile_role",
      "role_v2": "app.user_role",
      "bio": "text",
      "photo_url": "text",
      "is_admin": "boolean",
      "created_at": "timestamptz",
      "updated_at": "timestamptz"
    }
  },
  "db_columns": {
    "auth.users": {
      "instance_id": "uuid",
      "id": "uuid",
      "aud": "character varying",
      "role": "character varying",
      "email": "character varying",
      "encrypted_password": "character varying",
      "email_confirmed_at": "timestamp with time zone",
      "invited_at": "timestamp with time zone",
      "confirmation_token": "character varying",
      "confirmation_sent_at": "timestamp with time zone",
      "recovery_token": "character varying",
      "recovery_sent_at": "timestamp with time zone",
      "email_change_token_new": "character varying",
      "email_change": "character varying",
      "email_change_sent_at": "timestamp with time zone",
      "last_sign_in_at": "timestamp with time zone",
      "raw_app_meta_data": "jsonb",
      "raw_user_meta_data": "jsonb",
      "is_super_admin": "boolean",
      "created_at": "timestamp with time zone",
      "updated_at": "timestamp with time zone",
      "phone": "text",
      "phone_confirmed_at": "timestamp with time zone",
      "phone_change": "text",
      "phone_change_token": "character varying",
      "phone_change_sent_at": "timestamp with time zone",
      "confirmed_at": "timestamp with time zone",
      "email_change_token_current": "character varying",
      "email_change_confirm_status": "smallint",
      "banned_until": "timestamp with time zone",
      "reauthentication_token": "character varying",
      "reauthentication_sent_at": "timestamp with time zone",
      "is_sso_user": "boolean",
      "deleted_at": "timestamp with time zone",
      "is_anonymous": "boolean"
    },
    "app.profiles": {
      "user_id": "uuid",
      "email": "text",
      "display_name": "text",
      "role": "USER-DEFINED",
      "role_v2": "USER-DEFINED",
      "bio": "text",
      "photo_url": "text",
      "is_admin": "boolean",
      "created_at": "timestamp with time zone",
      "updated_at": "timestamp with time zone",
      "avatar_media_id": "uuid",
      "stripe_customer_id": "text"
    }
  }
}
```

## Frontend/Backend auth wiring
- Issues: none
