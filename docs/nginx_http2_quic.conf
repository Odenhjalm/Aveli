# Example nginx proxy for Aveli backend/frontend with HTTP/2 + HTTP/3 (QUIC)

map $host $cors_allow_origin {
    default 'https://aveli.app';
    'staging.aveli.app' 'https://staging.aveli.app';
    'localhost' 'http://localhost:3000';
}

server {
    listen 443 ssl http2 reuseport;
    listen 443 quic reuseport;
    http2_push_preload on;
    server_name aveli.app;

    ssl_certificate /etc/letsencrypt/live/aveli.app/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/aveli.app/privkey.pem;
    ssl_protocols TLSv1.3;
    add_header Alt-Svc 'h3=":443"; ma=86400';

    location / {
        proxy_pass http://backend:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Request-Id $request_id;
        proxy_set_header X-Forwarded-Proto $scheme;

        add_header Access-Control-Allow-Origin $cors_allow_origin always;
        add_header Access-Control-Allow-Credentials true;
        add_header Access-Control-Allow-Headers 'Authorization,Content-Type';
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Methods 'GET,POST,PUT,PATCH,DELETE,OPTIONS' always;
            add_header Access-Control-Max-Age 86400;
            return 204;
        }
    }
}
